---
description: Comprehensive messaging system standards with error handling and optimization guidelines
globs:
  - "src/services/messaging*.py"
  - "src/services/models/messaging_models.py"
  - "**/messaging*.py"
alwaysApply: true
---

## **ğŸ“‹ MESSAGE TYPES, PRIORITIES & TAGS**

### **Message Types** (use UnifiedMessageType enum):
```python
class UnifiedMessageType(Enum):
    TEXT = "text"            # Standard one-to-one or one-to-many text messages
    BROADCAST = "broadcast"  # Bulk delivery to all agents simultaneously
    ONBOARDING = "onboarding" # Special type used during initialization
```
- **TEXT** â†’ Used for day-to-day communication, instructions, and feedback loops
- **BROADCAST** â†’ Efficient for mass announcements or synchronized commands across the swarm
- **ONBOARDING** â†’ Special initialization flow; ensures agents are ready before normal operations

### **Message Priorities** (use UnifiedMessagePriority enum):
```python
class UnifiedMessagePriority(Enum):
    NORMAL = "normal"      # Default for non-critical communication
    URGENT = "urgent"      # Reserved for onboarding or crisis events
```

### **Message Tags** (use UnifiedMessageTag enum):
```python
class UnifiedMessageTag(Enum):
    CAPTAIN = "captain"    # Marks origin as Agent-4 (the supervisory entity)
    ONBOARDING = "onboarding" # Provides scoping context for bootstrapping messages
    WRAPUP = "wrapup"      # Signals system closure or end-of-cycle summaries
```

## **ğŸš€ DELIVERY MODE FLAGS**

### **Core Delivery Modes**:
- `mode="pyautogui"` â†’ Default, using coordinate-based GUI automation
- `mode="inbox"` â†’ File-based messaging (writes JSON or text directly to inbox directories)

### **PyAutoGUI-Specific Options**:
- `use_paste=True` â†’ Fast clipboard pasting (default)
- `use_paste=False` â†’ Falls back to keystroke-by-keystroke delivery
- `new_tab_method="ctrl_t"` â†’ Opens new browser tab (default)
- `new_tab_method="ctrl_n"` â†’ Opens a new browser window, useful for agent isolation

### **Timing & Delay Parameters**:
- **Agent order** â†’ Hardcoded with Agent-4 (Captain) always last
- **Inter-agent delay** â†’ 1 second pause ensures focus switching stability
- **Tab creation wait** â†’ 1.0s buffer after spawning tab/window
- **Paste wait** â†’ 1.0s before pasting ensures clipboard propagation

## **âš™ï¸ CLI COMMAND-LINE FLAGS**

### **Message Content Flags**:
- `--message/-m` â†’ Required. Defines the content
- `--sender/-s` â†’ Sets origin (default: "Captain Agent-4")

### **Recipient Flags**:
- `--agent/-a` â†’ Directs message to specific agent
- `--bulk` â†’ Overrides to send to all agents

### **Message Property Flags**:
- `--type/-t` â†’ Message type (text, broadcast, onboarding)
- `--priority/-p` â†’ Sets priority (normal, urgent)
- `--high-priority` â†’ Hard override; forces urgent regardless of other flags

### **Delivery Control Flags**:
- `--mode` â†’ Selects between pyautogui and inbox
- `--no-paste` â†’ Forces typing rather than clipboard paste
- `--new-tab-method` â†’ Chooses between `ctrl_t` or `ctrl_n`

### **Special Workflow Flags**:
- `--onboarding` â†’ Bulk initialization
- `--onboard` â†’ Single-agent initialization
- `--onboarding-style` â†’ Friendly vs. Professional tone
- `--wrapup` â†’ Send end-of-cycle system closure message
- `--list-agents` â†’ Enumerates available agents
- `--coordinates` â†’ Displays PyAutoGUI coordinate map
- `--history` â†’ Shows prior delivery log
- `--get-next-task` â†’ Queries assigned task for an agent
- `--check-status` â†’ Collects current status from swarm

## **ğŸ”„ ORDER OF OPERATIONS (CRITICAL)**

### **1. CLI Argument Resolution**:
```
Parse Flags â†’ Validate Inputs â†’ Configure Message Properties â†’
Select Delivery Mode â†’ Set PyAutoGUI Parameters â†’ Execute Delivery
```

### **2. Message Construction**:
```
Instantiate UnifiedMessage â†’ Assign Type/Priority/Tags â†’
Attach Metadata (IDs, timestamps) â†’ Persist to History
```

### **3. Execution Sequence**:
```
Focus Target Window â†’ Clear Input â†’ Open Tab/Window â†’
Insert Content (paste or type) â†’ Confirm Delivery
```

### **4. Agent Processing Flow** (must be maintained):
```
Agent-1 â†’ Agent-2 â†’ Agent-3 â†’ Agent-5 â†’ Agent-6 â†’ Agent-7 â†’ Agent-8 â†’ Agent-4
```
**âš ï¸ Agent-4 (Captain) is ALWAYS processed LAST for supervisory closure**

## **ğŸ¯ PYAUTOGUI OPERATION SEQUENCE**

1. **Navigation** â†’ `moveTo` & `click` to focus target window
2. **Content Clearing** â†’ `ctrl+a` â†’ delete to clear existing input
3. **Environment Setup** â†’ Spawn new tab/window with hotkey
4. **Content Delivery** â†’ Paste from clipboard or type character-by-character
5. **Execution** â†’ Press enter to finalize message delivery

## **ğŸš¨ SYSTEM LIMITATIONS & REQUIRED FIXES**

### **Timing Rigidities** (MUST BE ADDRESSED):
- âŒ Fixed delays not adaptive to host performance
- âŒ Clipboard propagation is assumed constant, which may fail
- âŒ No system performance detection or dynamic adjustment

### **Error Handling Gaps** (CRITICAL):
- âŒ Failures silently ignored with no visibility
- âŒ No retry mechanisms for failed deliveries
- âŒ Missing pre-flight validation (PyAutoGUI availability, coordinates)

### **Flag Logic Weaknesses** (MUST FIX):
- âŒ `--bulk` and `--agent` conflict unchecked
- âŒ `--high-priority` doesn't consistently override `--priority`
- âŒ Default values differ between CLI and core library

### **Sequential Bottlenecks** (PERFORMANCE):
- âŒ No concurrency for parallel delivery
- âŒ No conditional ordering based on urgency or agent availability
- âŒ Linear processing creates unnecessary delays

## **ğŸ’¡ REQUIRED ENHANCEMENTS**

### **1. Adaptive Timing Engine** (IMPLEMENT FIRST):
```python
def measure_system_speed():
    """Benchmarks typing/paste/GUI delay dynamically"""
    return calibrated_delay

# Use: Replace hardcoded 1.0s delays with adaptive timing
```

### **2. Resilient Error Handling** (CRITICAL):
```python
def send_with_retry(msg, max_retries=3, base_delay=1.0):
    for attempt in range(max_retries):
        if send_message(msg):
            return True
        time.sleep(base_delay * (2 ** attempt))
    return False
```

### **3. Comprehensive Flag Validation** (BLOCKING):
```python
def validate_flags(args):
    if args.bulk and args.agent:
        raise ValueError("Cannot use --bulk with --agent")
    if args.high_priority:
        args.priority = "urgent"  # Force override
```

### **4. Intelligent Agent Ordering** (PERFORMANCE):
- **URGENT** â†’ Captain Agent-4 first for crisis response
- **NORMAL** â†’ Default sequence maintained
- **Customizable** â†’ Allow override for special operations

### **5. Parallelized Delivery** (SCALING):
```python
async def send_parallel(messages, concurrency_limit=3):
    semaphore = asyncio.Semaphore(concurrency_limit)
    async def _send(msg):
        async with semaphore:
            return await send_message_async(msg)
    return await asyncio.gather(*[_send(m) for m in messages])
```

### **6. Monitoring & Logging** (OBSERVABILITY):
- âœ… Add verbose logging for each step
- âœ… Persist retry attempts and outcomes
- âœ… Expose metrics (delivery time, success rate)
- âœ… Track failure patterns for optimization

## **ğŸ›¡ï¸ ENFORCEMENT RULES**

### **Prohibited Patterns**:
- âŒ Hardcoded timing delays (use adaptive system)
- âŒ Silent error handling (always log and retry)
- âŒ Missing flag validation (validate all combinations)
- âŒ Sequential-only delivery (implement parallel options)

### **Required Patterns**:
- âœ… Pre-flight checks before operations
- âœ… Comprehensive error handling with retries
- âœ… Flag combination validation
- âœ… Performance monitoring and logging
- âœ… Agent-4 last in all bulk operations

### **Code Review Requirements**:
- âœ… All new messaging code must include error handling
- âœ… Timing must be configurable/adaptive, not hardcoded
- âœ… Flag validation must prevent invalid combinations
- âœ… Parallel delivery options must be available
- âœ… Comprehensive logging for debugging and monitoring

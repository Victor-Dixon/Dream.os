---
description: Messaging system standards and protocols
globs:
  - "src/services/messaging*.py"
  - "src/services/models/messaging_models.py"
  - "**/messaging*.py"
alwaysApply: true
---

## **ğŸ“‹ MESSAGE TYPES, PRIORITIES & TAGS**

### **Message Types** (use UnifiedMessageType enum):
```python
class UnifiedMessageType(Enum):
    TEXT = "text"            # Standard one-to-one or one-to-many text messages
    BROADCAST = "broadcast"  # Bulk delivery to all agents simultaneously
    ONBOARDING = "onboarding" # Special type used during initialization
```
- **TEXT** â†’ Used for day-to-day communication, instructions, and feedback loops
- **BROADCAST** â†’ Efficient for mass announcements or synchronized commands across the swarm
- **ONBOARDING** â†’ Special initialization flow; ensures agents are ready before normal operations

### **Message Priorities** (use UnifiedMessagePriority enum):
```python
class UnifiedMessagePriority(Enum):
    NORMAL = "normal"      # Default for non-critical communication
    URGENT = "urgent"      # Reserved for onboarding or crisis events
```

### **Message Tags** (use UnifiedMessageTag enum):
```python
class UnifiedMessageTag(Enum):
    CAPTAIN = "captain"    # Marks origin as Agent-4 (the supervisory entity)
    ONBOARDING = "onboarding" # Provides scoping context for bootstrapping messages
    WRAPUP = "wrapup"      # Signals system closure or end-of-cycle summaries
```

## **ğŸš€ DELIVERY MODE FLAGS**

### **Core Delivery Modes**:
- `mode="pyautogui"` â†’ Default, using coordinate-based GUI automation
- `mode="inbox"` â†’ File-based messaging (writes JSON or text directly to inbox directories)

### **PyAutoGUI-Specific Options**:
- `use_paste=True` â†’ Fast clipboard pasting (default)
- `use_paste=False` â†’ Falls back to keystroke-by-keystroke delivery
- `new_tab_method="ctrl_t"` â†’ Opens new browser tab (default)
- `new_tab_method="ctrl_n"` â†’ Opens a new browser window, useful for agent isolation

### **Timing & Delay Parameters**:
- **Agent order** â†’ Hardcoded with Agent-4 (Captain) always last
- **Inter-agent delay** â†’ 1 second pause ensures focus switching stability
- **Tab creation wait** â†’ 1.0s buffer after spawning tab/window
- **Paste wait** â†’ 1.0s before pasting ensures clipboard propagation

## **âš™ï¸ CLI COMMAND-LINE FLAGS**

### **Message Content Flags**:
- `--message/-m` â†’ Required. Defines the content
- `--sender/-s` â†’ Sets origin (default: "Captain Agent-4")

### **Recipient Flags**:
- `--agent/-a` â†’ Directs message to specific agent
- `--bulk` â†’ Overrides to send to all agents

### **Message Property Flags**:
- `--type/-t` â†’ Message type (text, broadcast, onboarding)
- `--priority/-p` â†’ Sets priority (normal, urgent)
- `--high-priority` â†’ Hard override; forces urgent regardless of other flags

### **Delivery Control Flags**:
- `--mode` â†’ Selects between pyautogui and inbox
- `--no-paste` â†’ Forces typing rather than clipboard paste
- `--new-tab-method` â†’ Chooses between `ctrl_t` or `ctrl_n`

### **Special Workflow Flags**:
- `--onboarding` â†’ Bulk initialization
- `--onboard` â†’ Single-agent initialization
- `--onboarding-style` â†’ Friendly vs. Professional tone
- `--wrapup` â†’ Send end-of-cycle system closure message
- `--list-agents` â†’ Enumerates available agents
- `--coordinates` â†’ Displays PyAutoGUI coordinate map
- `--history` â†’ Shows prior delivery log
- `--get-next-task` â†’ Queries assigned task for an agent
- `--check-status` â†’ Collects current status from swarm

## **ğŸ”„ ORDER OF OPERATIONS (CRITICAL)**

### **1. CLI Argument Resolution**:
```
Parse Flags â†’ Validate Inputs â†’ Configure Message Properties â†’
Select Delivery Mode â†’ Set PyAutoGUI Parameters â†’ Execute Delivery
```

### **2. Message Construction**:
```
Instantiate UnifiedMessage â†’ Assign Type/Priority/Tags â†’
Attach Metadata (IDs, timestamps) â†’ Persist to History
```

### **3. Execution Sequence**:
```
Focus Target Window â†’ Clear Input â†’ Open Tab/Window â†’
Insert Content (paste or type) â†’ Confirm Delivery
```

### **4. Agent Processing Flow** (must be maintained):
```
Agent-1 â†’ Agent-2 â†’ Agent-3 â†’ Agent-5 â†’ Agent-6 â†’ Agent-7 â†’ Agent-8 â†’ Agent-4
```
**âš ï¸ Agent-4 (Captain) is ALWAYS processed LAST for supervisory closure**

## **ğŸ¯ PYAUTOGUI OPERATION SEQUENCE**

1. **Navigation** â†’ `moveTo` & `click` to focus target window
2. **Content Clearing** â†’ `ctrl+a` â†’ delete to clear existing input
3. **Environment Setup** â†’ Spawn new tab/window with hotkey
4. **Content Delivery** â†’ Paste from clipboard or type character-by-character
5. **Execution** â†’ Press enter to finalize message delivery

## **ğŸ“‹ Related Rules**

- Messaging contracts: `.cursor/rules/messaging-contracts.mdc`
- CLI flag validation: `.cursor/rules/messaging/cli-flags.mdc`
- PyAutoGUI operations: `.cursor/rules/messaging/pyautogui-operations.mdc`

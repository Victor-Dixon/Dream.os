# Docker Compose for Infrastructure Phase 3A
# Container orchestration foundation

version: '3.8'

services:
  # Flask web service
  flask_app:
    build:
      context: .
      dockerfile: Dockerfile.flask
    container_name: flask-service
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - ./logs:/app/logs
    networks:
      - tradingrobotplug-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # FastAPI analytics service
  fastapi_app:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    container_name: fastapi-service
    ports:
      - "8001:8001"
    environment:
      - FASTAPI_ENV=production
      - FASTAPI_DEBUG=false
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - ./logs:/app/logs
    networks:
      - tradingrobotplug-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Kong API Gateway (Phase 3A enterprise scaling)
  kong:
    image: kong:3.4
    container_name: kong-gateway
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/opt/kong/kong.yml"
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_PROXY_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
    ports:
      - "8000:8000"  # Kong proxy port
      - "8443:8443"  # Kong proxy SSL port
      - "127.0.0.1:8001:8001"  # Kong admin API
    volumes:
      - ./config/kong/kong.yml:/opt/kong/kong.yml:ro
      - ./ssl:/etc/ssl/certs:ro
    networks:
      - tradingrobotplug-network
    depends_on:
      - flask_app
      - fastapi_app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx reverse proxy / API Gateway (Infrastructure Block 4 finalization)
  nginx:
    image: nginx:alpine
    container_name: reverse-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl/certs:ro
      - ./logs/nginx:/var/log/nginx
    networks:
      - tradingrobotplug-network
    depends_on:
      - flask_app
      - fastapi_app
      - kong
    restart: unless-stopped

  # PostgreSQL database service
  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_DB: trading_robot
      POSTGRES_USER: trader
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - tradingrobotplug-network
    restart: unless-stopped

  # Redis cache service
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    networks:
      - tradingrobotplug-network
    restart: unless-stopped

networks:
  tradingrobotplug-network:
    driver: bridge

volumes:
  postgres_data:

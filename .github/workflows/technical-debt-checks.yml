name: Technical Debt Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly technical debt report every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  debt-scan:
    name: SSOT Technical Debt Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyyaml  # For config parsing

    - name: Run SSOT Debt Scanner (CI Mode)
      run: python tools/debt_scan.py --ci --baseline reports/debt_baseline.json

    - name: Upload debt scan reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debt-scan-reports
        path: reports/debt_scan.*
        retention-days: 30

  syntax-validation:
    name: Syntax Validation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Validate Python syntax
      run: |
        find . -name "*.py" \
          -not -path "./.git/*" \
          -not -path "./.venv/*" \
          -not -path "./__pycache__/*" \
          -not -path "./.pytest_cache/*" \
          -not -path "./node_modules/*" \
          -not -path "./archive/*" \
          -not -path "./archives/*" \
          -not -path "./src/trading_robot/core/robinhood_adapter.py" \
          -not -path "./src/tools/system_discovery_agent.py" \
          -not -path "./src/core/unified_service_base.py" \
          -not -path "./src/core/auto_gas_pipeline_system.py" \
          -not -path "./src/core/debate_to_gas_integration.py" \
          -not -path "./src/core/caching/intelligent_cache.py" \
          -not -path "./src/core/message_queue/core/processor.py" \
          -not -path "./src/core/safety/state_snapshots.py" \
          -not -path "./src/core/safety/blast_radius.py" \
          -not -path "./tools/github/github_manager.py" \
          -not -path "./*backup*/*" \
          -not -path "./*backup*.py" \
          -print0 \
          | xargs -0 -r python -m py_compile

    - name: Run project scan
      run: python main.py --scan-project

  weekly-debt-report:
    name: Weekly Technical Debt Report
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate weekly debt report
      run: python systems/technical_debt/weekly_debt_report.py

    - name: Upload debt report
      uses: actions/upload-artifact@v4
      with:
        name: weekly-technical-debt-report
        path: reports/technical_debt/
        retention-days: 90

    - name: Create issue for high debt score
      if: contains(join(github.workspace, '/reports/technical_debt/'), 'HIGH')
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'reports/technical_debt/debt_report_*.md';
          const glob = require('glob');

          glob(reportPath, (err, files) => {
            if (err) return;

            const latestReport = files.sort().pop();
            if (latestReport) {
              const content = fs.readFileSync(latestReport, 'utf8');

              // Check if debt score indicates high debt
              if (content.includes('HIGH') && content.includes('Technical Debt Score')) {
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸš¨ High Technical Debt Alert',
                  body: `Weekly technical debt scan detected high debt levels. See attached report.\n\n${content.substring(0, 1000)}...`,
                  labels: ['technical-debt', 'high-priority']
                });
              }
            }
          });

  pre-commit-checks:
    name: Pre-commit Quality Gates
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run all quality checks
      run: |
        # Syntax validation
        python main.py --scan-project

        # SSOT compliance
        python scripts/ssot_linter.py

        # Duplication prevention
        python scripts/ci_duplication_gate.py

        # Deprecated file checks
        python scripts/ci_check_deprecated_files.py

  test-validation:
    name: Test Suite Validation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run test suite
      run: |
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

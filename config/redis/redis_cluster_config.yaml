# Redis Cluster Configuration for Distributed Caching
# Infrastructure Block 5 - Database Optimization Phase
# Agent-3 (Infrastructure & DevOps) - 2026-01-07

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: tradingrobotplug
spec:
  serviceName: redis-cluster
  replicas: 6  # 3 masters + 3 replicas for high availability
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7.2-alpine
        ports:
        - containerPort: 6379
          name: redis
        command:
        - redis-server
        args:
        - /etc/redis/redis.conf
        volumeMounts:
        - name: redis-config
          mountPath: /etc/redis
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: redis-config
        configMap:
          name: redis-cluster-config
      - name: redis-data
        emptyDir: {}  # In production, use persistent volumes

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster-config
  namespace: tradingrobotplug
data:
  redis.conf: |
    # Redis Cluster Configuration
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout 5000
    cluster-slave-validity-factor 10
    cluster-migration-barrier 1
    cluster-require-full-coverage yes

    # Memory management
    maxmemory 256mb
    maxmemory-policy allkeys-lru
    maxmemory-samples 5

    # Persistence
    appendonly yes
    appendfsync everysec
    appendfilename "appendonly.aof"

    # Security
    protected-mode no
    bind 0.0.0.0

    # Performance
    tcp-keepalive 300
    timeout 0
    tcp-backlog 511

    # Logging
    loglevel notice
    logfile ""

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  namespace: tradingrobotplug
spec:
  type: ClusterIP
  ports:
  - port: 6379
    targetPort: 6379
    name: redis
  selector:
    app: redis-cluster

---
# Redis Sentinel for High Availability (Optional enhancement)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-sentinel
  namespace: tradingrobotplug
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis-sentinel
  template:
    metadata:
      labels:
        app: redis-sentinel
    spec:
      containers:
      - name: sentinel
        image: redis:7.2-alpine
        command:
        - redis-sentinel
        args:
        - /etc/redis/sentinel.conf
        ports:
        - containerPort: 26379
          name: sentinel
        volumeMounts:
        - name: sentinel-config
          mountPath: /etc/redis
      volumes:
      - name: sentinel-config
        configMap:
          name: redis-sentinel-config

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-sentinel-config
  namespace: tradingrobotplug
data:
  sentinel.conf: |
    sentinel monitor mymaster redis-cluster-0.redis-cluster.tradingrobotplug.svc.cluster.local 6379 2
    sentinel down-after-milliseconds mymaster 5000
    sentinel failover-timeout mymaster 60000
    sentinel parallel-syncs mymaster 1

---
# Application Configuration for Redis Integration
# This would be used in the Revenue Engine application

# Python Redis Client Configuration
REDIS_CONFIG = {
    "cluster": {
        "startup_nodes": [
            {"host": "redis-cluster-0.redis-cluster.tradingrobotplug.svc.cluster.local", "port": 6379},
            {"host": "redis-cluster-1.redis-cluster.tradingrobotplug.svc.cluster.local", "port": 6379},
            {"host": "redis-cluster-2.redis-cluster.tradingrobotplug.svc.cluster.local", "port": 6379},
        ],
        "decode_responses": True,
        "socket_timeout": 5,
        "socket_connect_timeout": 5,
        "socket_keepalive": True,
        "socket_keepalive_options": {1: 60},  # TCP_KEEPIDLE
        "health_check_interval": 30,
    },
    "cache": {
        "default_ttl": 3600,  # 1 hour
        "max_memory_policy": "allkeys-lru",
        "compression": True,
        "serializer": "json",
    }
}

# Cache Key Patterns for Revenue Engine
CACHE_KEYS = {
    "revenue_metrics": "revenue:metrics:{metric_id}",
    "user_session": "session:user:{user_id}",
    "api_response": "api:response:{endpoint}:{params_hash}",
    "database_query": "db:query:{table}:{query_hash}",
    "feature_flag": "feature:{flag_name}",
    "rate_limit": "ratelimit:{identifier}:{window}"
}

# Cache TTL Configurations
CACHE_TTL = {
    "session": 3600,        # 1 hour
    "api_response": 300,    # 5 minutes
    "database_query": 600,  # 10 minutes
    "feature_flag": 300,    # 5 minutes (short for quick updates)
    "rate_limit": 60,       # 1 minute
    "metrics": 3600,        # 1 hour
}

# Cache Invalidation Patterns
INVALIDATION_PATTERNS = {
    "user_data": "session:user:{user_id}",
    "revenue_updates": "revenue:metrics:*",
    "api_changes": "api:response:*",
    "feature_updates": "feature:*",
}

# Distributed Lock Configuration
REDIS_LOCKS = {
    "default_timeout": 30,
    "retry_count": 3,
    "retry_delay": 0.1,
    "lock_prefix": "lock:",
}

# Pub/Sub Channels for Cache Coordination
PUBSUB_CHANNELS = {
    "cache_invalidation": "cache:invalidate",
    "service_discovery": "service:discovery",
    "config_updates": "config:updates",
    "health_checks": "health:status",
}

# Monitoring Configuration
REDIS_MONITORING = {
    "metrics_interval": 60,  # Collect metrics every minute
    "alert_thresholds": {
        "memory_usage": 0.8,  # Alert at 80% memory usage
        "connection_count": 100,  # Alert at 100 connections
        "hit_rate": 0.5,  # Alert if hit rate drops below 50%
    }
}
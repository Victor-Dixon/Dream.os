# Phase 5 Database Optimization Configuration
# Advanced PostgreSQL and Redis optimization settings

# PostgreSQL Performance Tuning
postgresql:
  # Connection Pooling
  max_connections: 200
  shared_preload_libraries: 'pg_stat_statements,pg_buffercache'

  # Memory Configuration
  shared_buffers: 512MB
  effective_cache_size: 2GB
  work_mem: 8MB
  maintenance_work_mem: 128MB
  wal_buffers: 16MB

  # Checkpoint Configuration
  checkpoint_completion_target: 0.9
  wal_level: replica
  max_wal_senders: 10
  wal_keep_size: 1GB

  # Query Optimization
  random_page_cost: 1.1
  effective_io_concurrency: 200
  default_statistics_target: 100

  # Logging Configuration
  log_line_prefix: '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
  log_statement: 'ddl'
  log_duration: on
  log_min_duration_statement: 1000

  # Connection Pooling (pgbouncer)
  pgbouncer:
    listen_addr: '*'
    listen_port: 6432
    auth_type: md5
    auth_file: /etc/pgbouncer/userlist.txt
    pool_mode: transaction
    max_client_conn: 1000
    default_pool_size: 20
    reserve_pool_size: 5
    reserve_pool_timeout: 3
    server_idle_timeout: 30
    client_idle_timeout: 30

# Redis Advanced Configuration
redis:
  # Memory Management
  maxmemory: 512mb
  maxmemory-policy: allkeys-lru
  maxmemory-samples: 5

  # Connection Management
  tcp-keepalive: 300
  tcp-backlog: 511
  timeout: 0
  databases: 16

  # Persistence
  save: '900 1 300 10 60 10000'
  stop-writes-on-bgsave-error: no
  rdbcompression: yes
  rdbchecksum: yes

  # Append Only File
  appendonly: yes
  appendfilename: 'appendonly.aof'
  appendfsync: everysec
  no-appendfsync-on-rewrite: no
  auto-aof-rewrite-percentage: 100
  auto-aof-rewrite-min-size: 64mb

  # Replication (for Phase 5 scaling)
  # replicaof: master-host 6379
  # masterauth: master-password

  # Security
  requirepass: ${REDIS_PASSWORD:-changeme123}
  rename-command: 'CONFIG ""'

  # Performance
  lua-time-limit: 5000
  slowlog-log-slower-than: 10000
  slowlog-max-len: 128

# Database Monitoring Queries
monitoring:
  postgresql:
    # Connection status
    active_connections: "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"
    waiting_queries: "SELECT count(*) FROM pg_stat_activity WHERE waiting = true;"
    cache_hit_ratio: "SELECT sum(blks_hit)*100/sum(blks_hit+blks_read) as cache_hit_ratio FROM pg_stat_database;"

    # Table statistics
    table_sizes: "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size FROM pg_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;"

    # Index usage
    unused_indexes: "SELECT indexrelname, idx_scan FROM pg_stat_user_indexes WHERE idx_scan = 0;"

  redis:
    # Memory usage
    memory_usage: "INFO memory"
    keyspace_info: "INFO keyspace"
    command_stats: "INFO commandstats"

    # Connection info
    connected_clients: "INFO clients"

    # Performance stats
    stats: "INFO stats"
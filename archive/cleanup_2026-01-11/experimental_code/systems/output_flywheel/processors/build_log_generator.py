"""
Build-log Generator Processor (S4)
=================================

Generates a simple build-log markdown file summarizing:
- session metadata (duration, files changed, commits)
- recent commits
- notable changes
"""

from __future__ import annotations

import logging
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List

logger = logging.getLogger(__name__)


def _format_commit(commit: Dict[str, Any]) -> str:
    """Format a single commit for markdown output."""
    ts = commit.get("timestamp", "")
    msg = commit.get("message", "").strip()
    author = commit.get("author", "unknown")
    return f"- **{ts[:19]}** {msg} ({author})"


def generate_build_log(
    session: Dict[str, Any],
    repo_stats: Dict[str, Any],
    output_dir: Path,
) -> Path:
    """
    Generate a build-log markdown file for the given session.

    Args:
        session: work_session-style dict.
        repo_stats: repo dict from repo_scanner.scan_repo_to_dict.
        output_dir: base directory for build-log artifacts.

    Returns:
        Path to generated build-log markdown file.
    """
    output_dir.mkdir(parents=True, exist_ok=True)

    session_id = session.get("session_id", "unknown-session")
    session_type = session.get("session_type", "build")
    metadata = session.get("metadata") or {}

    commits: List[Dict[str, Any]] = repo_stats.get("commits") or []
    files_changed = repo_stats.get("files_changed", metadata.get("files_changed", 0))
    duration = metadata.get("duration_minutes")
    commit_count = len(commits) or metadata.get("commits", 0)

    now = datetime.utcnow().isoformat(timespec="seconds")
    file_path = output_dir / f"build_log_{session_id}.md"

    lines: List[str] = []
    lines.append(f"# Build Log - {session_id}")
    lines.append("")
    lines.append(f"**Generated**: {now} UTC  ")
    lines.append(f"**Session Type**: {session_type}  ")
    lines.append(f"**Agent**: {session.get('agent_id', 'Agent-?')}")
    lines.append("")
    lines.append("## ğŸ“Š Session Summary")
    lines.append("")
    if duration is not None:
        lines.append(f"- **Duration**: {duration} minutes")
    lines.append(f"- **Files Changed**: {files_changed}")
    lines.append(f"- **Commits**: {commit_count}")
    lines.append("")

    if commits:
        lines.append("## ğŸ§¾ Recent Commits")
        lines.append("")
        for commit in commits[:10]:
            lines.append(_format_commit(commit))
        lines.append("")

    lines.append("## ğŸ“ Notes")
    lines.append("")
    lines.append("- Build-log generated by Dream.OS Output Flywheel v1.0.")
    lines.append("- Expand this section with more detailed notes as needed.")
    lines.append("")

    file_path.write_text("\n".join(lines), encoding="utf-8")
    logger.info("Build log generated at %s", file_path)
    return file_path



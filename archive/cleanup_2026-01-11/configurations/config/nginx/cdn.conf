# CDN & Static Asset Optimization Configuration
# Phase 5D - Global Content Delivery

# CDN upstream servers (example configuration)
upstream cdn_backends {
    server cdn1.dream.os:443;
    server cdn2.dream.os:443 backup;
}

# CDN-enabled location block
location /cdn/ {
    # CDN proxy with caching
    proxy_pass https://cdn_backends;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # CDN caching headers
    add_header X-CDN-Cache $upstream_cache_status always;
    add_header Cache-Control "public, max-age=31536000, immutable" always;

    # Compression
    gzip on;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # CDN-specific timeouts
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # CDN error handling
    proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
}

# Static asset optimization with CDN fallback
location /static/ {
    # Primary: Serve from local with CDN headers
    alias /app/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-CDN-Origin "local" always;

    # CDN optimization headers
    add_header Link "</cdn/; rel=\"dns-prefetch\"" always;

    # Compression
    gzip_static on;
    gzip on;
    gzip_types
        text/css
        application/javascript
        image/svg+xml
        font/woff2;

    # Security headers for static assets
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;

    # Fallback to CDN if local file not found
    try_files $uri @cdn_fallback;
}

# CDN fallback location
location @cdn_fallback {
    # Fallback to CDN if local file missing
    proxy_pass https://cdn.dream.os/static/;
    proxy_set_header Host cdn.dream.os;

    # CDN fallback headers
    add_header X-CDN-Origin "fallback" always;
    add_header Cache-Control "public, max-age=86400";

    # Error handling
    proxy_intercept_errors on;
    error_page 404 = /static/not-found.png;
}

# Image optimization with CDN
location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
    # Image optimization
    location ~* \.(jpg|jpeg)$ {
        image_filter jpeg_quality 85;
    }

    location ~* \.png$ {
        image_filter png_quality 85;
    }

    # CDN caching for images
    expires 6M;
    add_header Cache-Control "public, immutable";
    add_header X-CDN-Cache "image" always;

    # WebP conversion support
    location ~* \.(jpg|jpeg|png)$ {
        try_files $uri$webp_suffix @cdn_fallback;
        add_header Vary Accept always;
    }
}

# Font optimization with CDN
location ~* \.(woff|woff2|ttf|eot)$ {
    # Font caching
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin *;

    # Font security
    add_header X-Content-Type-Options nosniff;

    # CDN font delivery
    add_header X-CDN-Cache "font" always;
}